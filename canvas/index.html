<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Diagramo</title>
    <meta name="description" content="The coding diagram creator">
    <meta name="author" content="break.">

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="js/libraries/jquery.js" type="text/javascript"></script>
    <script src="js/libraries/ace/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/my-mode.js" type="text/javascript" charset="utf-8"></script>

    <script src="js/libraries/p5/p5.min.js"></script>
    <script src="js/libraries/p5/addons/p5.dom.min.js"></script>
    <script src="js/libraries/p5/addons/p5.sound.min.js"></script>

    <style> 
        div #my-editors-div{
            resize: horizontal;
            overflow: auto;
            border: 0.1px solid lightgray;
        }
        div #diagrama{
            resize: horizontal;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div class="flex-container-row min-height-parent-height height-parent-height">
        <div id="my-editors-div" class="flex-container-column" style="width: 50%">
            <div id="my-editors-tabs">
                <div class="editor-tab active" data-number="1">new.dgm<span class="close-tab">x</span></div><button class="editor-tab" id="add-new-tab-button">+</button>
            </div>
            <div id="my-editors" class="flex-1">
                <div class="relative height-parent-height" id="editor-div">
                    <pre class="editor tab-content" id="editor-1">
class actor
    position: 10, 20
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Robustness_Diagram_Actor.svg/1024px-Robustness_Diagram_Actor.svg.png"
    label: "Actor"
    connect: []
end

object a1 is actor
    position: 50, 50
end</pre>
                </div>
            </div>
            <div id="my-console">
                <form action="http://localhost:8080/actions/upload-image.php">
                    <input type="file" name="pic" accept="image/*">
                    <input type="submit">
                </form>
            </div>
        </div>
        <div id="diagrama" class="flex-1" style="width: 50%;">
            <button style="position: absolute; right: 0; bottom: 0; margin-bottom: 15px; margin-right: 15px">Export</button>
        </div>
    </div>


    <script src="js/diagram-to-code.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/editor-tabs.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/server-communication.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/canvas.js"></script>
    <script>
     var editors = $('.editor');
     var numberOfEditors = editors.length;

     for (var i = 0; i < editors.length; i++) {
         var editor = ace.edit(editors[i]);
         //dawn, eclipse, github, iplastic
         editor.setTheme("ace/theme/dawn");
         editor.session.setMode("ace/mode/my-mode");
         editors[i].style.fontSize = '16px';
     }

     var currentEditorNumber = 1;
     var currentEditorFilename = $(".editor-tab.active").text();
     var currentEditor = ace.edit(editors[0]);
     
     

     $("#test1").on("click", function() {
         componentClickHandler('a1', currentEditor);
     });

     // on click that will trigger when any .editor-tab chld of #my-editors-tabs is clicked
     $("#my-editors-tabs").on("click", ".editor-tab", function(event) {
         if(event.target.id == "add-new-tab-button"){
             // pressed + tab
             addNewTab(numberOfEditors);
             createNewEditor(editors, numberOfEditors + 1, function(newEditor){
                 var editor = ace.edit(newEditor);
		 editor.setTheme("ace/theme/dawn");
                 editor.session.setMode("ace/mode/my-mode");
                 newEditor.style.fontSize = '16px';
             });
             numberOfEditors++;
         }
	 else if (event.target.className == "close-tab") {
	     console.log(event.target.parentElement)
	     event.target.parentElement.remove()
	     var editorNumber = event.target.parentElement.dataset.number;
	     deleteEditor(editors, editorNumber)
	 }
         else{
             tabClickHandler(event, function(clickedEditorNumber){
                 currentEditorNumber = clickedEditorNumber;
                 currentEditorFilename = $(".editor-tab.active").text();
                 currentEditor = ace.edit(editors[currentEditorNumber-1]);
                 console.log(currentEditor.getValue());
             });
         }
     })

     // AJAX: filename, entry (t ou f) e content

     var timeout;
     $('#editor-div').keypress(function() {
         if(timeout) {
             clearTimeout(timeout);
             timeout = null;
         }

         timeout = setTimeout(function() {

             var files = [];

             for(var i = 0; i < editors.length; i++){
                 var data = {};
                 data.name = "new" + i + ".dgm";
                 if(i == 0){
                     data.entry = true;
                     data.name = "new.dgm";
                 }
                 else{
                     data.entry = false;
                     data.name = "new" + (i + 1) + ".dgm";
                 }
                 
                 data.content = ace.edit(editors[i]).getValue();
                 files.push(data);
             }

             var url = "http://localhost:8080/compile";
	     
             var request = $.ajax({
                 type: "post",
                 url: url,
                 data: JSON.stringify(files),
		 dataType: "json",
		 contentType: "application/json",
                 success: function(res) {
		     if (res.errors != undefined && res.errors.length > 0) {
			 console.log(res)
		     } else {
			 parseElementsToDraw(res);
			 console.log(res);
		     }
                 },
                 error: function(err){
                     console.error("No connection to server");
                 },
	     });
         }, 1000)
     })
    </script>
</body>

</html>
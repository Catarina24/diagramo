<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Diagramo</title>
    <meta name="description" content="The coding diagram creator">
    <meta name="author" content="break.">

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="js/libraries/jquery-ui-1.12.1.custom/jquery-ui.css"></link>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="js/libraries/jquery.js" type="text/javascript"></script>
    <script src="js/libraries/jquery-ui-1.12.1.custom/jquery-ui.js" type="text/javascript"></script>
    <script src="js/libraries/ace/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/my-mode.js" type="text/javascript" charset="utf-8"></script>

    <script src="js/libraries/p5/p5.min.js"></script>
    <script src="js/libraries/p5/addons/p5.dom.min.js"></script>
    <script src="js/libraries/p5/addons/p5.sound.min.js"></script>

    
</head>

<body>
    <div class="flex-container-row min-height-parent-height height-parent-height">
        <div id="my-editors-div" class="flex-container-column" style="width: 50%">
            <div id="my-editors-tabs">
                <div class="editor-tab active" data-number="1">new.dgm<span class="close-tab">x</span></div><button class="editor-tab" id="add-new-tab-button">+</button>
            </div>
            <div id="my-editors" class="flex-1">
                <div class="relative height-parent-height" id="editor-div">
                    <pre class="editor tab-content" id="editor-1">
class actor
    position: 10, 20
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Robustness_Diagram_Actor.svg/1024px-Robustness_Diagram_Actor.svg.png"
    label: "Actor"
    connect: []
end

object a1 is actor
    position: 50, 50
end</pre>
                </div>
            </div>
            <div>
                <div class="tab">
                    <button class="tablinks active">Console</button>
                    <button class="tablinks">Resources</button>
                    <button class="tablinks" onclick="openProjectOptions(event, 'import-export')">Project</button>
                </div>
                
                <div id="import-export" class="tabcontent">
                    <button style="margin-right: 10px;">Import source code</button> 
                    <button style="margin-left: 10px;">Export source code</button>
                </div>
            </div>
            <div id="my-console">
                <form id="image-upload-form">
                    <input type="file" name="pic" accept="image/*">
                    <input type="submit">
                </form>
            </div>
        </div>
        <div id="diagrama" class="flex-1" >
            <button id="download" onclick="saveDiagram()">
                <i class="fa fa-download" aria-hidden="true"></i>
            </button>
        </div>
    </div>


    <script src="js/diagram-to-code.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/editor-tabs.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/server-communication.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/canvas.js"></script>

    <script>
        function openProjectOptions(evt, content) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(content).style.display = "block";
            evt.currentTarget.className += " active";
        }
    </script>

    <script>
     var editors = $('.editor');
     var numberOfEditors = editors.length;

     for (var i = 0; i < editors.length; i++) {
         var editor = ace.edit(editors[i]);
         //dawn, eclipse, github, iplastic
         editor.setTheme("ace/theme/dawn");
         editor.session.setMode("ace/mode/my-mode");
         editors[i].style.fontSize = '16px';
     }

     var currentEditorNumber = 1;
     var currentEditorFilename = $(".editor-tab.active").text();
     var currentEditor = ace.edit(editors[0]);
     
     

     $("#test1").on("click", function() {
         componentClickHandler('a1', currentEditor);
     });

     $('#image-upload-form').on("submit", function (event) {
            event.preventDefault();


            $.ajax({
                url: 'http://localhost:8080/actions/upload-image.php',
                type: 'POST',
                data: new FormData(this),
                contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
                processData: false, // NEEDED, DON'T OMIT THIS
                success: function (msg) {
                    console.log(msg);
                },
                complete: function(){
                    console.log("I came all the way here.");
                }
            });
        });

     // on click that will trigger when any .editor-tab chld of #my-editors-tabs is clicked
     $("#my-editors-tabs").on("click", ".editor-tab", function(event) {
         if(event.target.id == "add-new-tab-button"){
             // pressed + tab
             addNewTab(numberOfEditors);
             createNewEditor(editors, numberOfEditors + 1, function(newEditor){
                var editor = ace.edit(newEditor);
                editor.setTheme("ace/theme/dawn");
                editor.session.setMode("ace/mode/my-mode");
                newEditor.style.fontSize = '16px';
             });
             numberOfEditors++;
         }
	 else if (event.target.className == "close-tab") {
	     console.log(event.target.parentElement)
	     event.target.parentElement.remove()
	     var editorNumber = event.target.parentElement.dataset.number;
	     deleteEditor(editors, editorNumber)
	 }
         else{
             tabClickHandler(event, function(clickedEditorNumber){
                 currentEditorNumber = clickedEditorNumber;
                 currentEditorFilename = $(".editor-tab.active").text();
                 currentEditor = ace.edit(editors[currentEditorNumber-1]);
                 console.log(currentEditor.getValue());
             });
         }
     })

     $('#my-editors-div').resizable({ handles: 'e' });
     $('#my-editors-div').resize(function() {
	 const diagram = $('#diagrama');
	 resizeCanvas(diagram.width(), diagram.height())
	 updateCanvas(diagram.width(), diagram.height())
     });

     var timeout;
     $('#editor-div').keypress(function() {
         if(timeout) {
             clearTimeout(timeout);
             timeout = null;
         }

         timeout = setTimeout(function() {

             var files = [];

             for(var i = 0; i < editors.length; i++){
                 var data = {};
                 data.name = "new" + i + ".dgm";
                 if(i == 0){
                     data.entry = true;
                     data.name = "new.dgm";
                 }
                 else{
                     data.entry = false;
                     data.name = "new" + (i + 1) + ".dgm";
                 }
                 
                 data.content = ace.edit(editors[i]).getValue();
                 files.push(data);
             }

             var url = "http://localhost:8080/compile";
	     
             var request = $.ajax({
                 type: "post",
                 url: url,
                 data: JSON.stringify(files),
                dataType: "json",
                contentType: "application/json",
                 success: function(res) {
		     if (res.errors != undefined && res.errors.length > 0) {
			 console.log(res)
		     } else {
			 parseElementsToDraw(res);
			 console.log(res);
		     }
                 },
                 error: function(err){
                     console.error("No connection to server");
                 },
	     });
         }, 1000)
     })
    </script>
</body>

</html>